AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'PCI Application Service

  '
Parameters:
  ServiceName:
    Type: String
  Environment:
    Type: String
    Default: development
    AllowedValues:
    - development
    - staging
    - beta
Globals:
  Function:
    Timeout: 3
    Handler: app.lambdaHandler
    Runtime: nodejs14.x
    Architectures:
    - x86_64
    Layers:
    - Ref: AppLayers
Resources:
  HealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: HealthCheckFunction
      Events:
        HelloWorld:
          Type: Api
          Properties:
            Path: /health-check
            Method: get
            RestApiId:
              Ref: API
  AppLayers:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName:
        Fn::Sub: pci-${Environment}-${ServiceName}-dependencies
      Description:
        Fn::Sub: Dependencies for pci-${Environment}-${ServiceName}-service
      ContentUri: ../../src/dependencies
      CompatibleRuntimes:
      - nodejs14.x
      CompatibleArchitectures:
      - x86_64
      LicenseInfo: MIT
      RetentionPolicy: Retain
  API:
    Type: AWS::Serverless::Api
    Description:
      Fn::Sub: API-Gateway-${Environment} for ${ServiceName} Service
    Properties:
      StageName:
        Fn::Sub: PCIApiGateway-${Environment}-${ServiceName}
Outputs:
  API:
    Description: API Gateway for the PCI Service
    Value:
      Ref: API
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-api-gateway
  Environment:
    Description: Stack Environment
    Value:
      Fn::Sub: ${Environment}
  ServiceName:
    Description: Service Name
    Value:
      Fn::Sub: ${ServiceName}
